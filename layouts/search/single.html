{{ define "main" }}
<div class="container">
    <h1 class="search-results-heading">Search Results</h1>
    <div class="posts-section">
        <div id="search-container">
            <div id="search-results"><p class="search-no-results">Use the footer to search, then results will appear here.</p></div>
        </div>
        <script>
            (function() {
                var searchResults = document.getElementById('search-results');
                if (!searchResults) return;

                function escapeHtml(text) {
                    if (!text) return '';
                    var div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                function decodeHtmlEntities(text) {
                    if (!text) return '';
                    var entities = { '&rsquo;': "'", '&lsquo;': "'", '&rdquo;': '"', '&ldquo;': '"', '&hellip;': '\u2026', '&amp;': '&', '&lt;': '<', '&gt;': '>', '&quot;': '"', '&nbsp;': '\u00A0' };
                    return String(text).replace(/&[^;]+;/g, function(m) { return entities[m] || m; });
                }
                function truncateSummary(text, maxLen) {
                    var decoded = decodeHtmlEntities(text || '');
                    if (decoded.length <= maxLen) return decoded;
                    var truncated = decoded.slice(0, maxLen).replace(/\s+$/, '');
                    return truncated + '\u2026';
                }
                function getQueryParam(name) {
                    var params = new URLSearchParams(window.location.search);
                    return params.get(name) || '';
                }
                function render(docs) {
                    if (!docs.length) {
                        searchResults.innerHTML = '<p class="search-no-results">No results found.</p>';
                        return;
                    }
                    var html = '<div class="posts-list">';
                    docs.forEach(function(doc) {
                        var dateHtml = doc.dateFormatted ? '<div class="post-meta"><time datetime="' + escapeHtml(doc.date) + '">' + escapeHtml(decodeHtmlEntities(doc.dateFormatted)) + '</time></div>' : '';
                        html += '<article class="post-item">';
                        html += '<h3><a href="' + escapeHtml(doc.url) + '">' + escapeHtml(decodeHtmlEntities(doc.title)) + '</a></h3>';
                        html += dateHtml;
                        html += '<p class="post-summary">' + escapeHtml(truncateSummary(doc.summary || doc.content || '', 350)) + '</p>';
                        html += '</article>';
                    });
                    html += '</div>';
                    searchResults.innerHTML = html;
                }
                function runSearch(data, query) {
                    query = (query || '').toLowerCase();
                    if (query.length < 2) {
                        searchResults.innerHTML = '<p class="search-no-results">Type at least 2 characters to search.</p>';
                        return;
                    }
                    var docs = [];
                    for (var i = 0; i < data.documents.length; i++) {
                        var doc = data.documents[i];
                        var title = (doc.title || '').toLowerCase();
                        var content = (doc.content || '').toLowerCase();
                        if (title.indexOf(query) !== -1 || content.indexOf(query) !== -1) {
                            docs.push(doc);
                        }
                    }
                    render(docs);
                }

                var indexURL = window.location.origin + '/index.json';

                searchResults.innerHTML = '<p class="search-no-results">Loading search indexâ€¦</p>';
                fetch(indexURL)
                    .then(function(res) {
                        if (!res.ok) throw new Error(res.status);
                        return res.json();
                    })
                    .then(function(data) {
                        if (!data.documents || !data.documents.length) {
                            searchResults.innerHTML = '<p class="search-no-results">Search index is empty.</p>';
                            return;
                        }
                        var q = getQueryParam('q');
                        if (q && q.length >= 2) {
                            runSearch(data, q);
                        } else {
                            searchResults.innerHTML = '<p class="search-no-results">Use the footer to search, then results will appear here.</p>';
                        }
                    })
                    .catch(function() {
                        searchResults.innerHTML = '<p class="search-no-results">Could not load search index. Check that <code>/index.json</code> exists.</p>';
                    });
            })();
        </script>
    </div>
</div>
{{ end }}
