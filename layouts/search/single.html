{{ define "main" }}
<div class="container">
    <div class="posts-section">
        <div id="search-container">
            <input type="search" id="search-input" placeholder="Search the site..." autofocus>
            <div id="search-results"></div>
        </div>
        <script>
            (function() {
                var searchInput = document.getElementById('search-input');
                var searchResults = document.getElementById('search-results');
                if (!searchInput || !searchResults) return;

                function escapeHtml(text) {
                    if (!text) return '';
                    var div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                function getQueryParam(name) {
                    var params = new URLSearchParams(window.location.search);
                    return params.get(name) || '';
                }
                function render(docs) {
                    if (!docs.length) {
                        searchResults.innerHTML = '<p class="search-no-results">No results found.</p>';
                        return;
                    }
                    var html = '<div class="posts-list">';
                    docs.forEach(function(doc) {
                        var dateHtml = doc.dateFormatted ? '<div class="post-meta"><time datetime="' + escapeHtml(doc.date) + '">' + escapeHtml(doc.dateFormatted) + '</time></div>' : '';
                        html += '<article class="post-item">';
                        html += '<h3><a href="' + escapeHtml(doc.url) + '">' + escapeHtml(doc.title) + '</a></h3>';
                        html += dateHtml;
                        html += '<p class="post-summary">' + escapeHtml(doc.summary || '') + '</p>';
                        html += '</article>';
                    });
                    html += '</div>';
                    searchResults.innerHTML = html;
                }
                function runSearch(data, query) {
                    query = (query || searchInput.value.trim() || '').toLowerCase();
                    if (query.length < 2) {
                        searchResults.innerHTML = '';
                        return;
                    }
                    var docs = [];
                    for (var i = 0; i < data.documents.length; i++) {
                        var doc = data.documents[i];
                        var title = (doc.title || '').toLowerCase();
                        var content = (doc.content || '').toLowerCase();
                        if (title.indexOf(query) !== -1 || content.indexOf(query) !== -1) {
                            docs.push(doc);
                        }
                    }
                    render(docs);
                }

                var indexURL = window.location.origin + '/index.json';

                searchResults.innerHTML = '<p class="search-no-results">Loadingâ€¦</p>';
                fetch(indexURL)
                    .then(function(res) {
                        if (!res.ok) throw new Error(res.status);
                        return res.json();
                    })
                    .then(function(data) {
                        if (!data.documents || !data.documents.length) {
                            searchResults.innerHTML = '<p class="search-no-results">Search index is empty.</p>';
                            return;
                        }
                        searchInput.addEventListener('input', function() { runSearch(data); });
                        var q = getQueryParam('q');
                        if (q) {
                            searchInput.value = q;
                            runSearch(data, q);
                        } else {
                            searchResults.innerHTML = '';
                        }
                    })
                    .catch(function() {
                        searchResults.innerHTML = '<p class="search-no-results">Could not load search index. Check that <code>/index.json</code> exists.</p>';
                    });
            })();
        </script>
    </div>
</div>
{{ end }}
